<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>小程序分包优化实践 | 程广的博客</title>
    <meta name="description" content="小程序分包优化实践">
    <link rel="icon" href="/favicon.ico">
    <meta name="keywords" content="小程序分包优化实践">
    <link rel="preload" href="/assets/css/0.styles.9cddba79.css" as="style"><link rel="preload" href="/assets/js/app.89670727.js" as="script"><link rel="preload" href="/assets/js/4.4406d8e4.js" as="script"><link rel="prefetch" href="/assets/js/10.ace91f2a.js"><link rel="prefetch" href="/assets/js/11.3b608195.js"><link rel="prefetch" href="/assets/js/12.413b91a8.js"><link rel="prefetch" href="/assets/js/13.ab48ff00.js"><link rel="prefetch" href="/assets/js/14.25dcc4fa.js"><link rel="prefetch" href="/assets/js/15.6b5e7778.js"><link rel="prefetch" href="/assets/js/16.40eb4736.js"><link rel="prefetch" href="/assets/js/17.3e641b84.js"><link rel="prefetch" href="/assets/js/18.555933ed.js"><link rel="prefetch" href="/assets/js/19.4f838e67.js"><link rel="prefetch" href="/assets/js/2.5c5a7514.js"><link rel="prefetch" href="/assets/js/20.d7d9da56.js"><link rel="prefetch" href="/assets/js/21.d2f45f75.js"><link rel="prefetch" href="/assets/js/22.b6c45f53.js"><link rel="prefetch" href="/assets/js/23.ee6b5351.js"><link rel="prefetch" href="/assets/js/24.e1720f79.js"><link rel="prefetch" href="/assets/js/25.2f277c51.js"><link rel="prefetch" href="/assets/js/26.32910ba8.js"><link rel="prefetch" href="/assets/js/27.042118a8.js"><link rel="prefetch" href="/assets/js/28.4683130c.js"><link rel="prefetch" href="/assets/js/29.2c58d8df.js"><link rel="prefetch" href="/assets/js/3.2d73d0ea.js"><link rel="prefetch" href="/assets/js/30.3c5cf4a6.js"><link rel="prefetch" href="/assets/js/31.94a6c38e.js"><link rel="prefetch" href="/assets/js/32.9d42e194.js"><link rel="prefetch" href="/assets/js/33.5f3f3886.js"><link rel="prefetch" href="/assets/js/34.0e7d4b29.js"><link rel="prefetch" href="/assets/js/35.edc828d1.js"><link rel="prefetch" href="/assets/js/36.7e8b9416.js"><link rel="prefetch" href="/assets/js/37.00be8fac.js"><link rel="prefetch" href="/assets/js/38.27cd320c.js"><link rel="prefetch" href="/assets/js/39.4cfadd7b.js"><link rel="prefetch" href="/assets/js/40.ecfa9391.js"><link rel="prefetch" href="/assets/js/41.6452664b.js"><link rel="prefetch" href="/assets/js/42.492145a9.js"><link rel="prefetch" href="/assets/js/43.d0618976.js"><link rel="prefetch" href="/assets/js/44.61201bbf.js"><link rel="prefetch" href="/assets/js/45.d37de7d7.js"><link rel="prefetch" href="/assets/js/46.749bc106.js"><link rel="prefetch" href="/assets/js/47.4cca52b2.js"><link rel="prefetch" href="/assets/js/48.f982cd71.js"><link rel="prefetch" href="/assets/js/49.2e47e7ea.js"><link rel="prefetch" href="/assets/js/5.517b540a.js"><link rel="prefetch" href="/assets/js/50.f127c615.js"><link rel="prefetch" href="/assets/js/51.480178a3.js"><link rel="prefetch" href="/assets/js/52.8ad44059.js"><link rel="prefetch" href="/assets/js/53.362222ec.js"><link rel="prefetch" href="/assets/js/54.01f53e45.js"><link rel="prefetch" href="/assets/js/55.927ad5de.js"><link rel="prefetch" href="/assets/js/56.b159b3a5.js"><link rel="prefetch" href="/assets/js/57.b52b9cf2.js"><link rel="prefetch" href="/assets/js/6.206400df.js"><link rel="prefetch" href="/assets/js/7.7583b7ef.js"><link rel="prefetch" href="/assets/js/8.3952b964.js"><link rel="prefetch" href="/assets/js/9.e567a3f2.js">
    <link rel="stylesheet" href="/assets/css/0.styles.9cddba79.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">程广的博客</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">前端栈</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/WEB/Node/nvm-nrm-npm.html" class="nav-link">NodeJS</a></li><li class="dropdown-item"><!----> <a href="/WEB/ES6/array.html" class="nav-link">ES6</a></li><li class="dropdown-item"><!----> <a href="/WEB/JavaScript/js_this.html" class="nav-link">JavaScript</a></li><li class="dropdown-item"><!----> <a href="/WEB/Vue/vuepress-blog.html" class="nav-link">Vue</a></li><li class="dropdown-item"><!----> <a href="/WEB/React/react-router.html" class="nav-link">React</a></li><li class="dropdown-item"><!----> <a href="/WEB/MiniProgram/subpackage-optimize.html" class="nav-link router-link-exact-active router-link-active">小程序</a></li><li class="dropdown-item"><!----> <a href="/WEB/Engineering/git-commit-rules.html" class="nav-link">工程化</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">移动端</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Mobile/Android/android_fastlane.html" class="nav-link">Android</a></li><li class="dropdown-item"><!----> <a href="/Mobile/ReactNative/rn_fastlane.html" class="nav-link">ReactNative</a></li><li class="dropdown-item"><!----> <a href="/Mobile/IOS/urls.html" class="nav-link">IOS</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">后端栈</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/BackEnd/Java/" class="nav-link">Java基础</a></li><li class="dropdown-item"><!----> <a href="/BackEnd/Spring/" class="nav-link">Spring</a></li><li class="dropdown-item"><!----> <a href="/BackEnd/MySQL/mysql5.7_install.html" class="nav-link">MySQL</a></li><li class="dropdown-item"><!----> <a href="/BackEnd/Redis/" class="nav-link">Redis</a></li><li class="dropdown-item"><!----> <a href="/BackEnd/Nginx/" class="nav-link">Nginx</a></li><li class="dropdown-item"><!----> <a href="/BackEnd/Http/" class="nav-link">Http</a></li><li class="dropdown-item"><!----> <a href="/BackEnd/OS/" class="nav-link">操作系统</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">其他</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/other/Git/git.html" class="nav-link">Git</a></li><li class="dropdown-item"><!----> <a href="/other/private/uniapp_share.html" class="nav-link">个人</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">前端栈</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/WEB/Node/nvm-nrm-npm.html" class="nav-link">NodeJS</a></li><li class="dropdown-item"><!----> <a href="/WEB/ES6/array.html" class="nav-link">ES6</a></li><li class="dropdown-item"><!----> <a href="/WEB/JavaScript/js_this.html" class="nav-link">JavaScript</a></li><li class="dropdown-item"><!----> <a href="/WEB/Vue/vuepress-blog.html" class="nav-link">Vue</a></li><li class="dropdown-item"><!----> <a href="/WEB/React/react-router.html" class="nav-link">React</a></li><li class="dropdown-item"><!----> <a href="/WEB/MiniProgram/subpackage-optimize.html" class="nav-link router-link-exact-active router-link-active">小程序</a></li><li class="dropdown-item"><!----> <a href="/WEB/Engineering/git-commit-rules.html" class="nav-link">工程化</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">移动端</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Mobile/Android/android_fastlane.html" class="nav-link">Android</a></li><li class="dropdown-item"><!----> <a href="/Mobile/ReactNative/rn_fastlane.html" class="nav-link">ReactNative</a></li><li class="dropdown-item"><!----> <a href="/Mobile/IOS/urls.html" class="nav-link">IOS</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">后端栈</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/BackEnd/Java/" class="nav-link">Java基础</a></li><li class="dropdown-item"><!----> <a href="/BackEnd/Spring/" class="nav-link">Spring</a></li><li class="dropdown-item"><!----> <a href="/BackEnd/MySQL/mysql5.7_install.html" class="nav-link">MySQL</a></li><li class="dropdown-item"><!----> <a href="/BackEnd/Redis/" class="nav-link">Redis</a></li><li class="dropdown-item"><!----> <a href="/BackEnd/Nginx/" class="nav-link">Nginx</a></li><li class="dropdown-item"><!----> <a href="/BackEnd/Http/" class="nav-link">Http</a></li><li class="dropdown-item"><!----> <a href="/BackEnd/OS/" class="nav-link">操作系统</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">其他</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/other/Git/git.html" class="nav-link">Git</a></li><li class="dropdown-item"><!----> <a href="/other/private/uniapp_share.html" class="nav-link">个人</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first collapsable"><p class="sidebar-heading"><span>NodeJS</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>ES6</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>JavaScript</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Vue</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>React</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading open"><span>小程序</span> <span class="arrow down"></span></p> <ul class="sidebar-group-items"><li><a href="/WEB/MiniProgram/subpackage-optimize.html" class="active sidebar-link">小程序分包优化实践</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/WEB/MiniProgram/subpackage-optimize.html#背景" class="sidebar-link">背景</a></li><li class="sidebar-sub-header"><a href="/WEB/MiniProgram/subpackage-optimize.html#小程序简介" class="sidebar-link">小程序简介</a></li><li class="sidebar-sub-header"><a href="/WEB/MiniProgram/subpackage-optimize.html#小程序分包机制" class="sidebar-link">小程序分包机制</a></li><li class="sidebar-sub-header"><a href="/WEB/MiniProgram/subpackage-optimize.html#项目架构梳理" class="sidebar-link">项目架构梳理</a></li><li class="sidebar-sub-header"><a href="/WEB/MiniProgram/subpackage-optimize.html#代码依赖分析" class="sidebar-link">代码依赖分析</a></li><li class="sidebar-sub-header"><a href="/WEB/MiniProgram/subpackage-optimize.html#小程序打包面临问题" class="sidebar-link">小程序打包面临问题</a></li><li class="sidebar-sub-header"><a href="/WEB/MiniProgram/subpackage-optimize.html#小程序分包优化实践" class="sidebar-link">小程序分包优化实践</a></li><li class="sidebar-sub-header"><a href="/WEB/MiniProgram/subpackage-optimize.html#总结" class="sidebar-link">总结</a></li></ul></li><li><a href="/WEB/MiniProgram/popup-management.html" class="sidebar-link">弹窗管理</a></li></ul></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>工程化</span> <span class="arrow right"></span></p> <!----></div></li></ul> </div> <div class="page"> <div class="content"><h2 id="背景"><a href="#背景" class="header-anchor">#</a> 背景</h2> <blockquote><p>随着项目规模增大，小程序分包优化是必须要面对的问题。分包不合理，不仅影响项目迭代和上线计划，还关乎用户体验，甚至因此导致 C 端用户流失。本文主要介绍京东快递小程序分包过程中踩过的坑，以及小程序分包优化的一些建议。</p></blockquote> <h2 id="小程序简介"><a href="#小程序简介" class="header-anchor">#</a> 小程序简介</h2> <ul><li>小程序是一种不需要下载安装即可在各类宿主环境（手机 APP、车载系统、IOT 设备等）中使用的应用程序。</li> <li>小程序使用了双线程模型，包括逻辑层和渲染层：逻辑层 JSCore 负责运行 JavaScript 脚本，进行数据处理；渲染层使用 WebView 进行渲染，负责页面展示、处理用户交互。</li></ul> <p>小程序通信模型如图:
<img src="/assets/img/mini-architecture.43f4f7c7.jpg"></p> <h2 id="小程序分包机制"><a href="#小程序分包机制" class="header-anchor">#</a> 小程序分包机制</h2> <ul><li><p>小程序的优势之一就是无需下载安装即可运行。在用户打开小程序时，如果是首次使用，或者小程序版本有更新，宿主环境会下载最新代码包，我们称这个包为小程序的“主包”。为优化小程序首次启动下载时间，各小程序平台对主包大小有一定限制，如微信限制主包大小不能超过 2M。</p></li> <li><p>为了防止主包超限，以及更好地多人协作，开发人员可以对小程序进行分包，如将一组独立的功能页面作为分包打包，当用户进入分包页面时，宿主环境会动态下载对应分包，极大提高用户体验。小程序平台对分包大小限制为 20M。</p></li></ul> <p>小程序包加载流程图如图:</p> <img src="/assets/img/package-load.c2240fab.jpg"> <h2 id="项目架构梳理"><a href="#项目架构梳理" class="header-anchor">#</a> 项目架构梳理</h2> <ul><li>在分包优化前，首先对项目框架有个清晰地梳理，才能更好地明确优化方向。KFC小程序基于 Taro 多端开发框架，适配了微信、支付宝、抖音等多个 APP 渠道。</li></ul> <p>基础架构图如图:</p> <img src="/assets/img/infrastructure.cd766b8e.jpg"> <h2 id="代码依赖分析"><a href="#代码依赖分析" class="header-anchor">#</a> 代码依赖分析</h2> <p>依赖分析能帮我们确定项目代码依赖关系，根据依赖关系可以确定分包优化的代码、资源文件等。依赖分析主要有以下两种方式：</p> <ul><li><ol><li>通过小程序开发者工具的“代码依赖分析”插件，可以查看到各代码包的依赖情况。</li></ol></li> <li><ol start="2"><li>在Taro2.0以上版本中，使用了 Webpack 进行编译构建。可以通过添加 webpack-bundle-analyzer 插件，实现依赖分析的可视化展示。主要步骤如下：</li></ol></li> <li><p>a. 首先安装  webpack-bundle-analyzer  依赖:</p></li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>  npm install webpack<span class="token operator">-</span>bundle<span class="token operator">-</span>analyzer <span class="token operator">-</span><span class="token constant">D</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>b. 然后在 mini.webpackChain 中添加如下配置：</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code> const config = {
    ...
    mini: {
      webpackChain (chain, webpack) {
        chain.plugin('analyzer')
          .use(require('webpack-bundle-analyzer').BundleAnalyzerPlugin, [])
      }
    }
 }
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><ul><li>c. 然后通过运行编译命令，即可查看代码文件依赖关系及体积。</li></ul> <h2 id="小程序打包面临问题"><a href="#小程序打包面临问题" class="header-anchor">#</a> 小程序打包面临问题</h2> <p>随着需求迭代，KFC小程序主包早已接近阈值 2M，稍有不慎就会超包，影响上线计划。</p> <p><strong>京东快递小程序打包面临问题如下：</strong></p> <ul><li>图片资源过大，影响主包体积；</li> <li>第三方包引入不规范，导致打包后引入冗余代码；</li> <li>console、debugger 等测试代码未做优化，需要上线前手动删除；</li> <li>采用运行时而不是构建时进行多端小程序代码兼容；</li> <li>分包难度大，主包涉及寄件、查件等黄金流程页面，分包成本大；</li> <li>分包路径问题，有些页面路径已经给到外部，分包后涉及外部系统改造上线；</li></ul> <h2 id="小程序分包优化实践"><a href="#小程序分包优化实践" class="header-anchor">#</a> 小程序分包优化实践</h2> <p>本节主要介绍KFC小程序分包优化实践.</p> <h4 id="图片资源问题"><a href="#图片资源问题" class="header-anchor">#</a> 图片资源问题</h4> <ul><li>小程序主包的体积空间是“寸土寸金”的，建议将图片资源上传到 CDN，优先使用 CDN 图片。如有 tabbar 等必须用本地图片的情况，建议将本地图片压缩后再进行引入</li> <li>分包优化时建议优先处理图片资源，图片压缩可以请 UI 同学协助处理</li></ul> <h4 id="第三方包引入问题"><a href="#第三方包引入问题" class="header-anchor">#</a> 第三方包引入问题</h4> <p>项目开发中难免会引入第三方工具包，包引入不当会导致打包后体积过大。拿 lodash 举例，原来的引入方式如下</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>  <span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token keyword">get</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'lodash'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>上述引入打包结果如图：</p> <img src="/assets/img/lodash.8b3d29db.jpg"> <p>可以看到，lodash 包大小为 117KB。</p> <p>我们优化后的引入方式如下:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>  <span class="token keyword">import</span> <span class="token keyword">get</span> <span class="token keyword">from</span> <span class="token string">'lodash/get'</span>
  <span class="token keyword">import</span> isEmpty <span class="token keyword">from</span> <span class="token string">'lodash/isEmpty'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>打包结果如图：</p> <img src="/assets/img/lodash-1.59fcf541.jpg"> <p>可以看到，优化引入方式后 lodash 包大小只有 46KB，使主包体积减少了 60%。</p> <p>除了上述优化方法，还可以将 lodash 替换为“lodash-es”，“lodash-es”基于 ESM 打包方式，这样就能利用 tree-shaking 移除不必要的代码，同时还能保留了按需引入的写法。</p> <h4 id="关于-console、debugger-的打包优化"><a href="#关于-console、debugger-的打包优化" class="header-anchor">#</a> 关于 console、debugger 的打包优化</h4> <p>在原生开发中，项目中的 console、debugger 等调试代码占据了一定主包空间，往往需要上线前手动移除。京东快递小程序基于 Taro 框架开发，在编译构建时提供了代码压缩插件的支持，可以做如下优化配置：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code> module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  env<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token constant">NODE_ENV</span><span class="token operator">:</span> <span class="token string">'&quot;production&quot;'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  plugins<span class="token operator">:</span> <span class="token punctuation">{</span>
    uglify<span class="token operator">:</span> <span class="token punctuation">{</span>
      enable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      config<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token comment">// 配置项同 https://github.com/mishoo/UglifyJS2#minify-options</span>
        compress<span class="token operator">:</span> <span class="token punctuation">{</span>
          drop_console<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          drop_debugger<span class="token operator">:</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>上述是生产环境打包配置文件，在 plugins 新增 uglify 选项，在 config 下新增 compress 配置项，将“drop_console”和“drop_debugger”设置为 true，即可在生产环境打包阶段移除代码中的 console 和 debugger，减少包代码体积。</p> <h4 id="采用构建时进行多端小程序代码兼容"><a href="#采用构建时进行多端小程序代码兼容" class="header-anchor">#</a> 采用构建时进行多端小程序代码兼容</h4> <p>KFC小程序除了微信端，还适配支付宝和抖音小程序。对于某些只在特定平台才有的功能，采用运行时的适配方法如下：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>  <span class="token keyword">const</span> isAlipay <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">TARO_ENV</span> <span class="token operator">===</span> <span class="token string">'alipay'</span>
  <span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isAlipay<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'支付宝小程序特定功能'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>首先定义了一个全局变量，在运行时判断如果是支付宝小程序平台，执行支付宝小程序相关代码。上述代码构建后的结果如下：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>  <span class="token comment">// 支付宝小程序</span>
  <span class="token keyword">const</span> isAlipay <span class="token operator">=</span> <span class="token boolean">true</span>
  <span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isAlipay<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'支付宝小程序特定功能'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 非支付宝小程序</span>
  <span class="token keyword">const</span> isAlipay <span class="token operator">=</span> <span class="token boolean">false</span>
  <span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isAlipay<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'支付宝小程序特定功能'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>可以看到，在支付宝和非支付宝小程序，只是顶级作用域中 isAlipay 的值不一样，test 函数中代码是没有变化的。</p> <p>优化后的代码如下：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>  <span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">TARO_ENV</span> <span class="token operator">===</span> <span class="token string">'alipay'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'支付宝小程序特定功能'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>构建后的结果</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>  <span class="token comment">// 支付宝小程序</span>
  <span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'支付宝小程序特定功能'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 非支付宝小程序</span>
  <span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>可以看到，通过动态判断 process.env.TARO_ENV，构建后小程序只包含了自己平台相关的代码，大大减少了包体积（请注意区分 process.env.TARO_ENV 和 Taro.getEnv()，前者是编译构建时的变量，后者是运行时的变量）。</p> <h4 id="主包黄金流程页面分包、分包路径跳转问题"><a href="#主包黄金流程页面分包、分包路径跳转问题" class="header-anchor">#</a> 主包黄金流程页面分包、分包路径跳转问题</h4> <p>如果要对主包某个页面进行分包，但页面路径已提供给外部，分包改变路径后可能涉及其他系统改造上线。这种情况可以保留主包页面(空白页面)，代码做如下处理</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">PageA</span> <span class="token keyword">extends</span> <span class="token class-name">Taro<span class="token punctuation">.</span>Component</span><span class="token operator">&lt;</span>Props<span class="token punctuation">,</span> State<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> params <span class="token operator">=</span> <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$router<span class="token punctuation">,</span> <span class="token string">'params'</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
      <span class="token keyword">const</span> paramArr<span class="token operator">:</span> Array<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
      Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        params<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> paramArr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>params<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token keyword">let</span> url <span class="token operator">=</span> <span class="token string">'/packageSub/test/test'</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>paramArr<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        url <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">?</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>paramArr<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'&amp;'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">}</span>
      Taro<span class="token punctuation">.</span><span class="token function">redirectTo</span><span class="token punctuation">(</span><span class="token punctuation">{</span> url <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token constant">JSX</span><span class="token punctuation">.</span>Element <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">&lt;</span>View<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>View<span class="token operator">&gt;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>可以看到，主包 PageA 页面只保留了 componentDidMount 的代码，首先从路由参数中获取 params，参数转换之后通过 redirectTo 路由到分包页面，这样对跳转方是无感知的，同时将 PageA 主体移入了分包页面，减小了主包体积。</p> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <ul><li>小程序运行在各类宿主环境中，无需安装即可运行。因此保证小程序主包大小，对小程序进行分包优化能极大提升用户体验。</li></ul> <p><strong>对小程序分包优化时，要具体情况具体分析。要注意以下几点：</strong></p> <ul><li><ol><li>分包优化前，要做好项目框架梳理工作，明确分包方向；然后利用代码依赖分析工具进行包依赖分析，确定要分包的代码、资源文件等；</li></ol></li> <li><ol start="2"><li>优先处理图片资源加载、第三方包引入问题，然后进行正确打包配置，合理利用 process.env.TARO_ENV 进行平台差异处理，最后再考虑黄金流程页面分包；</li></ol></li> <li><ol start="3"><li>分包优化是个持续的过程，要培养分包的意识，日常工作按照最佳实践进行开发，才能保证系统稳定。</li></ol></li></ul></div> <div class="page-edit"><!----> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/WEB/React/react-router.html" class="prev">
          React-router
        </a></span> <span class="next"><a href="/WEB/MiniProgram/popup-management.html">
          弹窗管理
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/assets/js/app.89670727.js" defer></script><script src="/assets/js/4.4406d8e4.js" defer></script>
  </body>
</html>
